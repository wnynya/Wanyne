script(src="/resources/elements/lapis.mjs" type="module")
script(type="module").
  window.Lapis.Script = class {
    constructor() {
      this.id = (() => {
        try {
          throw new Error();
        } catch (e) {
          for (const s of e.stack.split('\n'))
            if (s.match(/(https?:\/\/.+\.mjs)/))
              return btoa(s.match(/(https?:\/\/.+\.mjs)/)[0]);
        }
      })();
      Lapis.scripts.cache[this.id] = this;
    }
    load() {}
    unload() {}
  };
  window.LapisScript = Lapis.Script;

  window.Lapis.ScriptElement = class extends HTMLElement {
    constructor() {
      super();
      this.eval = this.getAttribute('eval');
      if (this.eval) {
        eval(this.eval);
        return;
      }
      this.src = this.getAttribute('src');
      this.srco = this.src;
      if (!this.src) {
        return;
      }
      if (this.src.startsWith('/')) {
        this.src = 'https://' + window.Lapis.host + this.src;
      }
      this.id = btoa(this.src);
      if (Lapis.scripts.cache.hasOwnProperty(this.id)) {
        this.load();
      } else {
        if (!Lapis.scripts.elements.includes(this.id)) {
          Lapis.scripts.elements.push(this.id);
          const script = document.createElement('script');
          script.src = this.src;
          if (this.src.match(/\.mjs$/)) {
            script.type = 'module';
          }
          script.addEventListener('load', (event) => {
            this.load();
          });
          document.body.appendChild(script);
        }
      }
    }
    load() {
      if (
        !document
          .querySelector('main')
          .querySelector(`lapis-script[src="${this.srco}"]`)
      ) {
        return;
      }
      const runtime = Lapis.scripts.cache[this.id];
      if (Lapis.scripts.loads.includes(runtime)) {
        return;
      }
      runtime.load();
      Lapis.scripts.loads.push(runtime);
    }
  };
  customElements.define('lapis-script', Lapis.ScriptElement);

  window.Lapis.StyleElement = class extends HTMLElement {
    constructor() {
      super();
      this.src = this.getAttribute('src');
      this.srco = this.src;
      if (!this.src) {
        return;
      }
      if (this.src.startsWith('/')) {
        this.src = 'https://' + window.Lapis.host + this.src;
      }
      this.id = btoa(this.src);
      if (!Lapis.styles.includes(this.id)) {
        Lapis.styles.push(this.id);
        const link = document.createElement('link');
        link.type = 'text/css';
        link.rel = 'stylesheet';
        link.href = this.src;
        if (!Lapis.firstLoaded) {
          link.addEventListener('load', (event) => {
            Lapis.firstPageStyleLoaded(btoa(this.srco));
          });
        }
        document.body.appendChild(link);
      }
    }
  };
  customElements.define('lapis-style', Lapis.StyleElement);