"use strict";import{GetRequest}from"/resources/modules/request.mjs";let Lapis=new class{constructor(){this.scripts={elements:[],cache:{},loads:[],unload:()=>{for(let t of this.scripts.loads)t.unload();this.scripts.loads=[]}},this.asyncs={timeouts:[],intervals:[],clear:()=>{for(let t of this.asyncs.timeouts)this.clearTimeout(t);for(let e of this.asyncs.intervals)this.clearInterval(e);this.asyncs.timeouts=[],this.asyncs.intervals=[]}},this.styles=[],this.prefetched=[],this.checkCookie=!0;let t=this;this.aEvent=e=>{e.preventDefault();let s=e.target;for(;"A"!=s.nodeName;)s=s.parentElement;let i=s.href,r=s.target;t.goto(i,s.getAttribute("effect"),!0,r)},this.aUpdate=()=>{for(let e of document.querySelectorAll("a[href][lapis]"))e.removeEventListener("click",t.aEvent),e.addEventListener("click",t.aEvent)},this.observer=new IntersectionObserver((t,e)=>{for(let s of t)if(s.isIntersecting){let i=s.target.href,r=btoa(i);if(this.prefetched.includes(r))continue;this.prefetched.push(r),this.prefetch(i)}},{}),this.update(),window.addEventListener("load",()=>{t.update()}),window.addEventListener("popstate",()=>{t.goto(window.location.href,!1)});let e=cookies("owarimonogatari");setInterval(()=>{if(this.checkCookie){let t=cookies("owarimonogatari");t!=e&&(window.location.reload(),e=t)}},1e3)}goto(t,e,s=!0,i="_blank"){window.Nav&&window.Nav.lapisGoto(),s=(t=t.startsWith("/")?`https://${window.location.host}${t}`:t)!=window.location.href&&s;let r=t.match(/https?:\/?\/?([^/]+)(\/[^?]*)?(\?.+)?/);if(r[1]!=window.location.host){window.open(t,i);return}this.asyncs.clear(),this.scripts.unload();let l=[];s&&window.history.pushState(l,window.location.host,t),e=e||"curtain";let a=this;if("bar"==e){let o=new Loadingbar;function n(e){e.uri!=t&&(l.push(e.uri),window.history.replaceState(l,window.location.host,e.uri)),a.display(e.body),window.scrollTo({top:0,behavior:"smooth"}),o.end(),window.Cursor&&window.Cursor.lapisGoto(),window.Inputs&&window.Inputs.lapisGoto()}GetRequest(t).then(n).catch(n)}else if("curtain"==e){let h=new Curtain,c=null,p=!1;function n(e){e.uri!=t&&(l.push(e.uri),window.history.replaceState(l,window.location.host,e.uri)),a.display(e.body),window.scrollTo({top:0}),h.end(),window.Cursor&&window.Cursor.lapisGoto(),window.Inputs&&window.Inputs.lapisGoto()}function u(t){c=t,p&&n(c)}setTimeout(()=>{p=!0,c&&n(c)},h.timeblock*h.div+200),GetRequest(t).then(u).catch(u)}}display(t){let e=document.createElement("template");e.innerHTML=t;let s=e.content;for(let i of s.querySelectorAll('link[rel="preload"]'))i.parentElement.removeChild(i);function r(t,e,s){e.querySelector(s)&&t.querySelector(s)?e.querySelector(s).innerHTML=t.querySelector(s).innerHTML:e.querySelector(s)?.innerHTML&&(e.querySelector(s).innerHTML="")}function l(t,e,s){e.querySelector(s)&&t.querySelector(s)?e.querySelector(s).content=t.querySelector(s).content:e.querySelector(s)?.content&&(e.querySelector(s).content="")}r(s,document,"title"),r(s,document,"main"),r(s,document,"style#theme"),l(s,document,'meta[name="description"]'),r(s,document,'script[type="application/ld+json"]'),l(s,document,"link[rel=canonical]"),l(s,document,'meta[name="og:title"]'),l(s,document,'meta[name="og:description"]'),l(s,document,'meta[name="og:image"]'),l(s,document,'meta[name="twitter:title"]'),l(s,document,'meta[name="twitter:description"]'),l(s,document,'meta[name="twitter:image"]'),this.update()}prefetch(t){t!=window.location.href&&GetRequest(t).then(t=>{let e=document.createElement("template");for(let s of(e.innerHTML=t.body,e.content.querySelector("main").querySelectorAll("lapis-script[src], lapis-style[src]")))document.body.appendChild(s),document.body.removeChild(s)}).catch(t=>{})}update(){for(let t of(this.aUpdate(),this.observer.disconnect(),document.querySelectorAll("a[href][lapis]")))this.observer.observe(t)}setTimeout(t,e){let s=setTimeout(t,e);return this.asyncs.timeouts.push(s),s}clearTimeout(t){clearTimeout(t),this.asyncs.timeouts.splice(this.asyncs.timeouts.indexOf(t),1)}setInterval(t,e){let s=setInterval(t,e);return this.asyncs.intervals.push(s),s}clearInterval(t){clearInterval(t),this.asyncs.timeouts.splice(this.asyncs.intervals.indexOf(t),1)}Script=class{constructor(){this.uid=(()=>{try{throw Error()}catch(t){for(let e of t.stack.split("\n").reverse()){let s=e.match(/(https?:\/\/.+\.m?js)/);if(s)return btoa(s[0])}}})(),Lapis.scripts.cache[this.uid]=this}load(){}unload(){}};ScriptElement=class extends HTMLElement{constructor(){if(super(),this.getAttribute("eval")){eval(this.getAttribute("eval"));return}if(this.src=this.getAttribute("src"),this.srco=this.src,!this.src)return;if(this.src.startsWith("/")&&(this.src=`https://${window.location.host}${this.src}`),this.uid=btoa(this.src),Lapis.scripts.cache.hasOwnProperty(this.uid))this.load();else if(!Lapis.scripts.elements.includes(this.uid)){Lapis.scripts.elements.push(this.uid);let script=document.createElement("script");script.src=this.src,this.src.match(/\.mjs$/)&&(script.type="module"),script.addEventListener("load",t=>{this.load()}),document.body.appendChild(script)}}load(){if(!document.querySelector("main").querySelector(`lapis-script[src="${this.srco}"]`))return;let t=Lapis.scripts.cache[this.uid];!Lapis.scripts.loads.includes(t)&&(t.load(),Lapis.scripts.loads.push(t))}};StyleElement=class extends HTMLElement{constructor(){if(super(),this.src=this.getAttribute("src"),!this.src)return;if(this.src.startsWith("/")&&(this.src=`https://${window.location.host}${this.src}`),this.uid=btoa(this.src),!Lapis.styles.includes(this.uid)){Lapis.styles.push(this.uid);let t=document.createElement("link");t.type="text/css",t.rel="stylesheet",t.href=this.src,document.body.appendChild(t)}}}};class Loadingbar{constructor(){this.bar=document.createElement("div"),this.bar.style.position="fixed",this.bar.style.top=0,this.bar.style.left=0,this.bar.style.height="2px",this.bar.style.boxShadow="0 0 3px 0 var(--th-tl)",this.bar.style.background="var(--th)",this.bar.style.zIndex=2e8,this.bar.style.transition="width ease-out 0.2s",this.state="ready",this.percent=0,this.progress(this.percent),document.body.appendChild(this.bar),this.update=()=>{"ready"==this.state&&(this.percent+=.01,this.percent=Math.min(90,this.percent),window.requestAnimationFrame(this.update)),this.progress(this.percent)},window.requestAnimationFrame(this.update),setTimeout(()=>{this.percent=20},10)}progress(t){this.bar.style.width=t+"%"}end(){this.state="end",this.percent=100,this.progress(this.percent),setTimeout(()=>{this.destroy()},250)}destroy(){this.bar.style.left=null,this.bar.style.right=0,this.bar.style.width="0%",setTimeout(()=>{document.body.removeChild(this.bar)},250)}}class Curtain{constructor(t){this.curtain=document.createElement("div"),this.curtain.style.zIndex="2100000000",this.curtain.style.position="fixed",this.curtain.style.top="0",this.curtain.style.left="0",this.curtain.style.width="100vw",this.curtain.style.height="100vh",document.body.appendChild(this.curtain),this.div=Math.floor(window.innerWidth/Math.rem(4)),this.timeblock=10,this.block=window.innerWidth/this.div;for(let e=0;e<this.div;e++){let s=document.createElement("div");s.style.position="absolute",s.style.top="0",s.style.right=e*this.block-2+"px",s.style.height="100%",s.style.width="0px",s.style.background="var(--fg)",s.style.transition="width 0.2s ease-out, background 0.5s ease-out",this.curtain.appendChild(s)}let i=this.curtain.querySelectorAll("div"),r=0,l=setInterval(()=>{let t=i[r];t.style.width=this.block+4+"px",++r>=this.div&&clearInterval(l)},this.timeblock)}end(){setTimeout(()=>{let t=this.curtain.querySelectorAll("div");for(let e=0;e<t.length;e++){let s=t[e];s.style.right="unset",s.style.left=window.innerWidth-((e+1)*this.block+2)+"px"}let i=0,r=setInterval(()=>{let e=t[i];e.style.width="0px",++i>=this.div&&clearInterval(r)},this.timeblock)},200),setTimeout(()=>{document.body.removeChild(this.curtain)},this.timeblock*this.div+500+200)}}window.Curtain=Curtain,window.Lapis=Lapis,window.LapisScript=Lapis.Script,customElements.define("lapis-script",Lapis.ScriptElement),customElements.define("lapis-style",Lapis.StyleElement);