"use strict";import{GetRequest}from"/resources/modules/request.mjs";let Lapis=new class{constructor(){this.scripts={elements:[],cache:{},loads:[],unload:()=>{for(let t of this.scripts.loads)t.unload();this.scripts.loads=[]}},this.asyncs={timeouts:[],intervals:[],clear:()=>{for(let t of this.asyncs.timeouts)this.clearTimeout(t);for(let e of this.asyncs.intervals)this.clearInterval(e);this.asyncs.timeouts=[],this.asyncs.intervals=[]}},this.styles=[],this.prefetched=[];let t=this;this.aEvent=e=>{e.preventDefault();let s=e.target;for(;"A"!=s.nodeName;)s=s.parentElement;let i=s.href,r=s.target;t.goto(i,!0,r)},this.aUpdate=()=>{for(let e of document.querySelectorAll("a[href][lapis]"))e.removeEventListener("click",t.aEvent),e.addEventListener("click",t.aEvent)},this.observer=new IntersectionObserver((t,e)=>{for(let s of t)if(s.isIntersecting){let i=s.target.href,r=btoa(i);if(this.prefetched.includes(r))continue;this.prefetched.push(r),this.prefetch(i)}},{}),this.update(),window.addEventListener("load",()=>{t.update()}),window.addEventListener("popstate",()=>{t.goto(window.location.href,!1)});let e=cookies("owarimonogatari");setInterval(()=>{let t=cookies("owarimonogatari");t!=e&&(window.location.reload(),e=t)},1e3)}goto(t,e=!0,s="_blank"){window.Nav&&window.Nav.lapisGoto(),e=(t=t.startsWith("/")?`https://${window.location.host}${t}`:t)!=window.location.href&&e;let i=t.match(/https?:\/?\/?([^/]+)(\/[^?]*)?(\?.+)?/);if(i[1]!=window.location.host){window.open(t,s);return}this.asyncs.clear(),this.scripts.unload();let r=[];e&&window.history.pushState(r,window.location.host,t);let a=new Loadingbar,o=this;function l(e){e.uri!=t&&(r.push(e.uri),window.history.replaceState(r,window.location.host,e.uri)),o.display(e.body),window.scrollTo({top:0,behavior:"smooth"}),a.end(),window.Cursor&&window.Cursor.lapisGoto(),window.Inputs&&window.Inputs.lapisGoto()}GetRequest(t).then(l).catch(l)}display(t){let e=document.createElement("template");e.innerHTML=t;let s=e.content;for(let i of s.querySelectorAll('link[rel="preload"]'))i.parentElement.removeChild(i);function r(t,e,s){e.querySelector(s)&&t.querySelector(s)?e.querySelector(s).innerHTML=t.querySelector(s).innerHTML:e.querySelector(s)?.innerHTML&&(e.querySelector(s).innerHTML="")}function a(t,e,s){e.querySelector(s)&&t.querySelector(s)?e.querySelector(s).content=t.querySelector(s).content:e.querySelector(s)?.content&&(e.querySelector(s).content="")}r(s,document,"title"),r(s,document,"main"),a(s,document,'meta[name="description"]'),r(s,document,'script[type="application/ld+json"]'),a(s,document,"link[rel=canonical]"),a(s,document,'meta[name="og:title"]'),a(s,document,'meta[name="og:description"]'),a(s,document,'meta[name="og:image"]'),a(s,document,'meta[name="twitter:title"]'),a(s,document,'meta[name="twitter:description"]'),a(s,document,'meta[name="twitter:image"]'),this.update()}prefetch(t){t!=window.location.href&&GetRequest(t).then(t=>{let e=document.createElement("template");for(let s of(e.innerHTML=t.body,e.content.querySelector("main").querySelectorAll("lapis-script[src], lapis-style[src]")))document.body.appendChild(s),document.body.removeChild(s)}).catch(t=>{})}update(){for(let t of(this.aUpdate(),this.observer.disconnect(),document.querySelectorAll("a[href][lapis]")))this.observer.observe(t)}setTimeout(t,e){let s=setTimeout(t,e);return this.asyncs.timeouts.push(s),s}clearTimeout(t){clearTimeout(t),this.asyncs.timeouts.splice(this.asyncs.timeouts.indexOf(t),1)}setInterval(t,e){let s=setInterval(t,e);return this.asyncs.intervals.push(s),s}clearInterval(t){clearInterval(t),this.asyncs.timeouts.splice(this.asyncs.intervals.indexOf(t),1)}Script=class{constructor(){this.uid=(()=>{try{throw Error()}catch(t){for(let e of t.stack.split("\n").reverse()){let s=e.match(/(https?:\/\/.+\.m?js)/);if(s)return btoa(s[0])}}})(),Lapis.scripts.cache[this.uid]=this}load(){}unload(){}};ScriptElement=class extends HTMLElement{constructor(){if(super(),this.getAttribute("eval")){eval(this.getAttribute("eval"));return}if(this.src=this.getAttribute("src"),this.srco=this.src,!this.src)return;if(this.src.startsWith("/")&&(this.src=`https://${window.location.host}${this.src}`),this.uid=btoa(this.src),Lapis.scripts.cache.hasOwnProperty(this.uid))this.load();else if(!Lapis.scripts.elements.includes(this.uid)){Lapis.scripts.elements.push(this.uid);let script=document.createElement("script");script.src=this.src,this.src.match(/\.mjs$/)&&(script.type="module"),script.addEventListener("load",t=>{this.load()}),document.body.appendChild(script)}}load(){if(!document.querySelector("main").querySelector(`lapis-script[src="${this.srco}"]`))return;let t=Lapis.scripts.cache[this.uid];!Lapis.scripts.loads.includes(t)&&(t.load(),Lapis.scripts.loads.push(t))}};StyleElement=class extends HTMLElement{constructor(){if(super(),this.src=this.getAttribute("src"),!this.src)return;if(this.src.startsWith("/")&&(this.src=`https://${window.location.host}${this.src}`),this.uid=btoa(this.src),!Lapis.styles.includes(this.uid)){Lapis.styles.push(this.uid);let t=document.createElement("link");t.type="text/css",t.rel="stylesheet",t.href=this.src,document.body.appendChild(t)}}}};class Loadingbar{constructor(){this.bar=document.createElement("div"),this.bar.style.position="fixed",this.bar.style.top=0,this.bar.style.left=0,this.bar.style.height="2px",this.bar.style.boxShadow="0 0 3px 0 var(--th-tl)",this.bar.style.background="var(--th)",this.bar.style.zIndex=2e8,this.bar.style.transition="width ease-out 0.2s",this.state="ready",this.percent=0,this.progress(this.percent),document.body.appendChild(this.bar),this.update=()=>{"ready"==this.state&&(this.percent+=.01,this.percent=Math.min(90,this.percent),window.requestAnimationFrame(this.update)),this.progress(this.percent)},window.requestAnimationFrame(this.update),setTimeout(()=>{this.percent=20},10)}progress(t){this.bar.style.width=t+"%"}end(){this.state="end",this.percent=100,this.progress(this.percent),setTimeout(()=>{this.destroy()},250)}destroy(){this.bar.style.left=null,this.bar.style.right=0,this.bar.style.width="0%",setTimeout(()=>{document.body.removeChild(this.bar)},250)}}window.Lapis=Lapis,window.LapisScript=Lapis.Script,customElements.define("lapis-script",Lapis.ScriptElement),customElements.define("lapis-style",Lapis.StyleElement);